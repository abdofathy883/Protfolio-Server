name: DeployServer

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

    - name: Deploy via SSH (API + Admin Dashboard)
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          set -e

            # ====== Repo folder ======
            APP_DIR="/var/www/portfolio-back"
            API_OUT="/var/www/portfolio-back-out/ClientAPI"
            ADMIN_OUT="/var/www/portfolio-back-out/AdminDashboard"

            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            # ====== Ensure repo exists and is clean ======
            if [ ! -d ".git" ]; then
              git init
              git remote add origin https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_TOKEN }}@github.com/abdofathy883/Protfolio-Server.git
            else
              git remote set-url origin https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_TOKEN }}@github.com/abdofathy883/Protfolio-Server.git
            fi

            git fetch origin master
            git reset --hard origin/master

            # ====== Publish API ======
            echo "Publishing ClientAPI..."
            dotnet publish ClientAPI/ClientAPI.csproj -c Release -o "$API_OUT"

            # ====== Publish Admin Dashboard ======
            echo "Publishing AdminDashboard..."
            dotnet publish AdminDashboard/AdminDashboard.csproj -c Release -o "$ADMIN_OUT"

            # ====== Restart services ======
            echo "Restarting services..."
            systemctl restart portfolio-clientapi.service
            systemctl restart portfolio-admindashboard.service

            systemctl status portfolio-clientapi.service --no-pager -l
            systemctl status portfolio-admindashboard.service --no-pager -l

            # ====== Reload nginx ======
            nginx -t && systemctl reload nginx

            echo "âœ… Deploy done"
          EOF